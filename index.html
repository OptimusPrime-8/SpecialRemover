<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Intelligent Word Cleaner</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
button { margin-right: 10px; padding: 6px 12px; }
#status { margin-top:10px; min-height:24px; }
</style>
</head>
<body>

<h2>Intelligent Word Cleaner</h2>
<input type="file" id="fileInput" accept=".docx" />
<div>
  <button id="uploadBtn">Upload</button>
  <button id="processBtn" disabled>Process</button>
  <button id="downloadBtn" disabled>Download</button>
</div>
<div id="status">Status: waiting for upload...</div>

<script type="module">
// Import ES module versions of docx and FileSaver
import * as docx from "https://cdn.jsdelivr.net/npm/docx@7.1.3/build/index.mjs";
import { saveAs } from "https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.mjs";
import mammoth from "https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js";

const uploadBtn = document.getElementById("uploadBtn");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");

let uploadedFile = null;
let cleanedText = "";
let processedBlob = null;
let originalFileName = "processed_document.docx";

// Character replacement map
const charMap = {
  "à":"a","À":"A","è":"e","È":"E","é":"e","É":"E",
  "ì":"i","Ì":"I","ò":"o","Ò":"O","ù":"u","Ù":"U",
  "—":", "
};

function setStatus(msg){ statusEl.textContent = "Status: " + msg; }

function cleanText(text){
  let out = text;
  for(const [k,v] of Object.entries(charMap)){ out = out.split(k).join(v); }
  return out.replace(/[^\x00-\x7F•,\t\n\r ]/g,""); // remove unwanted chars
}

// Upload
uploadBtn.onclick = () => {
  if(!fileInput.files[0]) { setStatus("Please select a Word (.docx) file."); return; }
  uploadedFile = fileInput.files[0];
  originalFileName = uploadedFile.name.replace(/\.[^/.]+$/,"") + "_cleaned.docx";
  processedBlob = null;
  setStatus("File uploaded. Ready to process.");
  processBtn.disabled = false;
  downloadBtn.disabled = true;
};

// Process
processBtn.onclick = async () => {
  if(!uploadedFile){ setStatus("Upload a file first."); return; }
  setStatus("Processing...");
  try {
    const arrayBuffer = await uploadedFile.arrayBuffer();
    const result = await mammoth.extractRawText({arrayBuffer});
    cleanedText = cleanText(result.value || "");

    // Generate new DOCX
    const doc = new docx.Document({
      sections: [{
        properties: {},
        children: [
          new docx.Paragraph({
            children: [
              new docx.TextRun({ text: cleanedText, font:"Times New Roman", size:24 })
            ]
          })
        ]
      }]
    });

    processedBlob = await docx.Packer.toBlob(doc);
    downloadBtn.disabled = false;
    setStatus("Processing complete. Ready to download.");
  } catch(err) {
    console.error(err);
    setStatus("Error during processing: " + err);
  }
};

// Download
downloadBtn.onclick = () => {
  if(!processedBlob){ setStatus("No processed file to download."); return; }
  saveAs(processedBlob, originalFileName);
  setStatus("Download started.");
};

</script>

</body>
</html>
