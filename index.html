<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clean Word Document and Download</title>
</head>
<body>
<input type="file" id="wordFile" accept=".docx">
<button id="uploadBtn">Upload</button>
<button id="processBtn">Process</button>
<button id="downloadBtn">Download</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.3/docx.min.js"></script>
<script>
const charMap = {
    "à": "a", "À": "A",
    "è": "e", "È": "E",
    "é": "e", "É": "E",
    "ì": "i", "Ì": "I",
    "ò": "o", "Ò": "O",
    "ù": "u", "Ù": "U",
    "—": ", "
};
const exceptionalWords = new Set(["μ","µ"]);

let uploadedContent = []; // store paragraphs from original doc
let processedContent = [];

function cleanText(text) {
    if(exceptionalWords.has(text.trim())) return text;
    let newText = text;
    for(const [k,v] of Object.entries(charMap)) {
        newText = newText.split(k).join(v);
    }
    // remove non-ASCII except bullet and comma
    newText = newText.split('').map(ch => (/[\x00-\x7F]/.test(ch) || ch==='•'||ch===',') ? ch : '').join('');
    return newText;
}

async function extractWordContent(file) {
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = function() {
            mammoth.convertToHtml({arrayBuffer: reader.result})
            .then(result=>{
                // Convert HTML paragraphs into simple structure
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = result.value;
                const paragraphs = Array.from(tempDiv.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li'));
                const content = paragraphs.map(p=>{
                    return {
                        text: p.textContent || '',
                        tag: p.tagName.toLowerCase(),
                        bold: p.style.fontWeight==='bold',
                        italic: p.style.fontStyle==='italic'
                    };
                });
                resolve(content);
            })
            .catch(err=>reject(err));
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

// Upload
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
    const file = document.getElementById('wordFile').files[0];
    if(!file) return alert("Select a Word file.");
    try{
        uploadedContent = await extractWordContent(file);
        alert("File uploaded successfully!");
    }catch(err){
        console.error(err);
        alert("Error reading Word file.");
    }
});

// Process
document.getElementById('processBtn').addEventListener('click', ()=>{
    if(uploadedContent.length===0) return alert("Upload file first.");
    processedContent = uploadedContent.map(p=>{
        return {...p, text: cleanText(p.text)};
    });
    alert("Text processed successfully!");
});

// Download
document.getElementById('downloadBtn').addEventListener('click', async ()=>{
    if(processedContent.length===0) return alert("Process file first.");

    const doc = new docx.Document({
        sections: [{
            properties:{},
            children: processedContent.map(p=>{
                return new docx.Paragraph({
                    heading: p.tag.startsWith('h') ? docx.HeadingLevel[p.tag.toUpperCase()] : undefined,
                    bullet: p.tag==='li' ? {level:0} : undefined,
                    children:[
                        new docx.TextRun({
                            text: p.text,
                            bold: p.bold,
                            italics: p.italic,
                            font: "Times New Roman"
                        })
                    ]
                });
            })
        }]
    });

    try{
        const blob = await docx.Packer.toBlob(doc);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Write_Analyzed.docx"; // Set the desired file name here
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }catch(err){
        console.error(err);
        alert("Error generating Word file.");
    }
});
</script>
</body>
</html>