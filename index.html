<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload, Process, and Download Word Document</title>
</head>
<body>
    <h1>Upload, Process, and Download Word Document</h1>

    <input type="file" id="wordFile" accept=".doc,.docx">
    <button id="uploadBtn">Upload</button>
    <button id="processBtn">Process</button>
    <button id="downloadBtn">Download</button>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.3/docx.min.js"></script>

    <script>
        const charMap = {
            "à": "a", "À": "A",
            "è": "e", "È": "E",
            "é": "e", "É": "E",
            "ì": "i", "Ì": "I",
            "ò": "o", "Ò": "O",
            "ù": "u", "Ù": "U",
            "—": ", "
        };
        const exceptionalWords = new Set(["μ", "µ"]);

        let uploadedText = "";
        let processedText = "";
        let originalFileName = "";

        function cleanText(text) {
            if (exceptionalWords.has(text.trim())) return text;

            let changes = [];
            for (const [k, v] of Object.entries(charMap)) {
                if (text.includes(k)) {
                    changes.push(k);
                    text = text.split(k).join(v);
                }
            }

            let newText = "";
            for (const ch of text) {
                if (/[\x00-\x7F]/.test(ch) || ch === "•" || ch === ",") {
                    newText += ch;
                } else {
                    changes.push(ch);
                }
            }

            if (changes.length > 0) console.log(`Replaced/removed: ${[...new Set(changes)].sort().join(", ")}`);
            return newText;
        }

        async function readWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    mammoth.extractRawText({ arrayBuffer: reader.result })
                        .then(result => resolve(result.value))
                        .catch(err => reject(err));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Upload button
        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const file = document.getElementById("wordFile").files[0];
            if (!file) return alert("Please select a Word file to upload.");

            try {
                uploadedText = await readWordFile(file);
                processedText = ""; // reset
                originalFileName = file.name;
                alert("File uploaded successfully!");
            } catch (err) {
                alert("Error reading Word file.");
                console.error(err);
            }
        });

        // Process button
        document.getElementById("processBtn").addEventListener("click", () => {
            if (!uploadedText) return alert("No file uploaded.");
            processedText = cleanText(uploadedText);
            alert("Text processed successfully!");
        });

        // Download button
        document.getElementById("downloadBtn").addEventListener("click", async () => {
            if (!processedText) return alert("Please process the text before downloading.");

            const doc = new docx.Document({
                sections: [
                    {
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                children: [ new docx.TextRun({ text: processedText, font: "Times New Roman" }) ]
                            })
                        ]
                    }
                ]
            });

            try {
                const blob = await docx.Packer.toBlob(doc);
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = originalFileName; // same file name
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                alert("File downloaded successfully!");
            } catch (err) {
                alert("Error generating Word document.");
                console.error(err);
            }
        });
    </script>
</body>
</html>
