<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Intelligent Word Cleaner</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
button { margin-right: 10px; padding: 6px 12px; }
#status { margin-top:10px; min-height:24px; }
</style>
</head>
<body>

<h2>Intelligent Word Cleaner</h2>
<input type="file" id="fileInput" accept=".doc,.docx" />
<div>
  <button id="uploadBtn">Upload</button>
  <button id="processBtn" disabled>Process</button>
  <button id="downloadBtn" disabled>Download</button>
</div>
<div id="status">Status: waiting for upload...</div>

<script type="module">
// Import necessary modules
import mammoth from "https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js";
import { Document, Packer, Paragraph, TextRun } from "https://cdn.jsdelivr.net/npm/docx@7.3.0/build/index.mjs";
import { saveAs } from "https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.mjs";

const uploadBtn = document.getElementById("uploadBtn");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");

let uploadedFile = null;
let cleanedText = "";
let processedBlob = null;
let originalFileName = "processed_document.docx";

// Character replacement map for cleaning
const charMap = {
  "à":"a","À":"A","è":"e","È":"E","é":"e","É":"E",
  "ì":"i","Ì":"I","ò":"o","Ò":"O","ù":"u","Ù":"U",
  "—":", "
};

function setStatus(msg){ statusEl.textContent = "Status: " + msg; }

function cleanText(text){
  let out = text;
  for(const [k,v] of Object.entries(charMap)){ out = out.split(k).join(v); }
  // Remove non-ASCII characters except for specific symbols, tabs, and newlines
  return out.replace(/[^\x00-\x7F•,\t\n\r ]/g,"");
}

// 1. Upload Process: Handles the file selection
uploadBtn.onclick = () => {
  if(!fileInput.files[0]) {
    setStatus("Please select a Word (.doc or .docx) file.");
    return;
  }
  uploadedFile = fileInput.files[0];
  originalFileName = uploadedFile.name.replace(/\.[^/.]+$/,"") + "_cleaned.docx";
  processedBlob = null;
  setStatus("File uploaded. Ready to process.");
  processBtn.disabled = false;
  downloadBtn.disabled = true;
};

// 2. Process Button: Cleans the uploaded document
processBtn.onclick = async () => {
  if(!uploadedFile){
    setStatus("Upload a file first.");
    return;
  }
  setStatus("Processing...");
  try {
    const arrayBuffer = await uploadedFile.arrayBuffer();
    // Extract raw text using Mammoth
    const result = await mammoth.extractRawText({arrayBuffer});
    cleanedText = cleanText(result.value || "");

    // Create a new DOCX document with the cleaned text
    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({
            children: [
              new TextRun({ text: cleanedText, font:"Times New Roman", size:24 })
            ]
          })
        ]
      }]
    });

    // Pack the document into a blob for download
    processedBlob = await Packer.toBlob(doc);
    downloadBtn.disabled = false;
    setStatus("Processing complete. Ready to download.");
  } catch(err) {
    console.error(err);
    setStatus("Error during processing: " + err.message);
  }
};

// 3. Download Process: Saves the cleaned document
downloadBtn.onclick = () => {
  if(!processedBlob){
    setStatus("No processed file to download.");
    return;
  }
  // Use FileSaver to trigger the download
  saveAs(processedBlob, originalFileName);
  setStatus("Download started.");
};

</script>

</body>
</html>
