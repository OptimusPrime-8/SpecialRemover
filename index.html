<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Word Processor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.3/docx.min.js"></script>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
button { margin-right: 10px; padding: 6px 12px; }
#status { margin-top:10px; min-height:24px; }
</style>
</head>
<body>

<h2>Word Processor</h2>
<input type="file" id="fileInput" accept=".docx" />
<div>
  <button id="uploadBtn">Upload</button>
  <button id="processBtn" disabled>Process</button>
  <button id="downloadBtn" disabled>Download</button>
</div>
<div id="status">Status: waiting for upload...</div>

<script>
const uploadBtn = document.getElementById("uploadBtn");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");

let uploadedFile = null;
let cleanedText = "";
let originalFileName = "processed_document.docx";

const charMap = {"à":"a","À":"A","è":"e","È":"E","é":"e","É":"E","ì":"i","Ì":"I","ò":"o","Ò":"O","ù":"u","Ù":"U","—":", "};

function setStatus(msg){ statusEl.textContent = "Status: " + msg; }

function cleanText(text){
  let out = text;
  for(const [k,v] of Object.entries(charMap)){ out = out.split(k).join(v); }
  return out.replace(/[^\x00-\x7F•,\t\n\r ]/g,"");
}

uploadBtn.onclick = () => {
  if(!fileInput.files[0]) { setStatus("Please select a .docx file."); return; }
  uploadedFile = fileInput.files[0];
  originalFileName = uploadedFile.name.replace(/\.[^/.]+$/,"") + "_processed.docx";
  setStatus("File uploaded. Ready to process.");
  processBtn.disabled = false;
};

processBtn.onclick = () => {
  if(!uploadedFile) { setStatus("Upload a file first."); return; }
  setStatus("Processing...");
  const reader = new FileReader();
  reader.onload = function(e){
    const arrayBuffer = e.target.result;
    mammoth.extractRawText({arrayBuffer: arrayBuffer})
      .then(result => {
        cleanedText = cleanText(result.value);
        setStatus("Text cleaned. Ready to download.");

        // Generate new .docx
        const doc = new docx.Document({
          sections: [{
            properties: {},
            children: [
              new docx.Paragraph({children:[new docx.TextRun({text: cleanedText, font:"Times New Roman", size:24})]})
            ]
          }]
        });

        docx.Packer.toBlob(doc).then(blob=>{
          downloadBtn.onclick = () => { saveAs(blob, originalFileName); };
          downloadBtn.disabled = false;
        });
      })
      .catch(err => setStatus("Error processing file: " + err));
  };
  reader.readAsArrayBuffer(uploadedFile);
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>
