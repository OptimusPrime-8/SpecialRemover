<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload and Process Word Document</title>
</head>
<body>
    <h1>Upload Your Word Document for Processing</h1>

    <input type="file" id="wordFile" accept=".docx">
    <button id="uploadBtn">Upload</button>
    <button id="processDownloadBtn">Process and Download</button>

    <h3>Uploaded Text</h3>
    <div id="result"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.3/docx.min.js"></script>

    <script>
        // Character map for replacing Italian accented characters
        const charMap = {
            "à": "a", "À": "A",
            "è": "e", "È": "E",
            "é": "e", "É": "E",
            "ì": "i", "Ì": "I",
            "ò": "o", "Ò": "O",
            "ù": "u", "Ù": "U",
            "—": ", "
        };

        const exceptionalWords = new Set(["μ", "µ"]);
        let uploadedText = ""; // store uploaded text

        function cleanText(text) {
            if (exceptionalWords.has(text.trim())) return text;

            let changes = [];

            for (const [k, v] of Object.entries(charMap)) {
                if (text.includes(k)) {
                    changes.push(k);
                    text = text.split(k).join(v);
                }
            }

            text = removeUnwantedSpecials(text, changes);

            if (changes.length > 0) console.log(`Changes: ${[...new Set(changes)].sort().join(", ")}`);

            return text;
        }

        function removeUnwantedSpecials(text, changes) {
            let newText = "";
            for (const ch of text) {
                if (/[\x00-\x7F]/.test(ch) || ch === "•" || ch === ",") {
                    newText += ch;
                } else {
                    changes.push(ch);
                }
            }
            return newText;
        }

        async function readWordFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    const arrayBuffer = reader.result;
                    mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                        .then(result => resolve(result.value))
                        .catch(err => reject(err));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        document.getElementById("uploadBtn").addEventListener("click", async () => {
            const file = document.getElementById("wordFile").files[0];
            if (!file) return alert("Please select a file to upload.");

            try {
                uploadedText = await readWordFile(file);
                document.getElementById("result").textContent = uploadedText;
            } catch (err) {
                console.error("Error uploading file:", err);
            }
        });

        document.getElementById("processDownloadBtn").addEventListener("click", async () => {
            if (!uploadedText) return alert("No file uploaded yet.");

            const cleanedText = cleanText(uploadedText);

            const doc = new docx.Document({
                sections: [
                    {
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: cleanedText,
                                        font: "Times New Roman",
                                    }),
                                ],
                            }),
                        ],
                    },
                ],
            });

            const blob = await docx.Packer.toBlob(doc);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "processed_document.docx";
            link.click();
            URL.revokeObjectURL(link.href);
        });
    </script>
</body>
</html>
